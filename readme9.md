- создал новую виртуальную машину 

- изменил параметры согласно условиям домашнего задания: 
    `alter system set checkpoint_timeout = 30;`
    `alter system set log_checkpoints = on;`
- перечитал файл конфигурации: `select pg_reload_conf();`
- проверил: 

    `show checkpoint_timeout;show log_checkpoints;` 

    ```sql
     checkpoint_timeout
    --------------------
     30s
    (1 строка)
    
     log_checkpoints
    -----------------
     on
    (1 строка)
    ```

   
- проверил текущий [LSN]  

    `select pg_current_wal_insert_lsn();`
    
    ```sql  
     pg_current_wal_insert_lsn
    ---------------------------
    0/BD675D10
    (1 строка)
    ```  
- сбросил статистику
    `select pg_stat_reset();`
-  количество выполненных до текущего момента контрольных точек: 

    `select checkpoints_timed from pg_stat_bgwriter;` 

    ```sql
    -[ RECORD 1 ]-------------+----------
    checkpoints_timed | 7
    ```
- запустил _pgbench_: `pgbench -c 8 -P 60 -T 600 -U postgres postgres`

- после отработки _pgbench_: 
    - контрольных точек: 30 
    - значение LSN: 0/D4DC3640 

- вычислим число байт между этими двумя позициями LSN
    `select '0/D4DC3640'::pg_lsn -  '0/BD675D10'::pg_lsn  as byte_size;
 
    ```sql
     byte_size
    -----------
    393533744
    (1 строка)
    ```
- количество выполненных контрольных точек за 600 секунд = 30 - 7 -> 23  

     **на одну контрольную точку приходится 17 110 162 байт (~16 709 Kb = ~16,3 Mb)**

- проверил записи о выполнении контрольных точек в журнале: 
    `grep контрольная /var/log/postgresql/postgresql-14-main.'
```
        2023-03-10 13:24:40.279 UTC [1727] СООБЩЕНИЕ:  начата контрольная точка: time
        2023-03-10 13:24:55.165 UTC [1727] СООБЩЕНИЕ:  контрольная точка завершена: записано буферов: 1778 (1.4%); добавлено файлов WAL 0, удалено: 0, переработано: 1; запись=14.686 сек., синхр.=0.096 сек., всего=14.887 сек.; синхронизировано_файлов=25, самая_долгая_синхр.=0.018 сек., средняя=0.004 сек.; расстояние=15182 kB, ожидалось=18701 kB
        2023-03-10 13:25:10.181 UTC [1727] СООБЩЕНИЕ:  начата контрольная точка: time
        2023-03-10 13:25:25.149 UTC [1727] СООБЩЕНИЕ:  контрольная точка завершена: записано буферов: 1901 (1.5%); добавлено файлов WAL 0, удалено: 0, переработано: 2; запись=14.782 сек., синхр.=0.087 сек., всего=14.968 сек.; синхронизировано_файлов=23, самая_долгая_синхр.=0.019 сек., средняя=0.004 сек.; расстояние=19019 kB, ожидалось=19019 kB
        2023-03-10 13:25:40.163 UTC [1727] СООБЩЕНИЕ:  начата контрольная точка: time
        2023-03-10 13:25:55.094 UTC [1727] СООБЩЕНИЕ:  контрольная точка завершена: записано буферов: 1955 (1.5%); добавлено файлов WAL 0, удалено: 0, переработано: 1; запись=14.794 сек., синхр.=0.046 сек., всего=14.931 сек.; синхронизировано_файлов=24, самая_долгая_синхр.=0.013 сек., средняя=0.002 сек.; расстояние=19084 kB, ожидалось=19084 kB
        2023-03-10 13:26:10.107 UTC [1727] СООБЩЕНИЕ:  начата контрольная точка: time
        2023-03-10 13:26:25.140 UTC [1727] СООБЩЕНИЕ:  контрольная точка завершена: записано буферов: 1973 (1.5%); добавлено файлов WAL 0, удалено: 0, переработано: 1; запись=14.890 сек., синхр.=0.051 сек., всего=15.034 сек.; синхронизировано_файлов=24, самая_долгая_синхр.=0.010 сек., средняя=0.003 сек.; расстояние=19149 kB, ожидалось=19149 kB
        2023-03-10 13:26:40.155 UTC [1727] СООБЩЕНИЕ:  начата контрольная точка: time
        2023-03-10 13:26:55.198 UTC [1727] СООБЩЕНИЕ:  контрольная точка завершена: записано буферов: 1930 (1.5%); добавлено файлов WAL 0, удалено: 0, переработано: 1; запись=14.883 сек., синхр.=0.080 сек., всего=15.043 сек.; синхронизировано_файлов=23, самая_долгая_синхр.=0.014 сек., средняя=0.004 сек.; расстояние=18923 kB, ожидалось=19127 kB
        2023-03-10 13:27:10.213 UTC [1727] СООБЩЕНИЕ:  начата контрольная точка: time
        2023-03-10 13:27:25.119 UTC [1727] СООБЩЕНИЕ:  контрольная точка завершена: записано буферов: 1909 (1.5%); добавлено файлов WAL 0, удалено: 0, переработано: 1; запись=14.777 сек., синхр.=0.052 сек., всего=14.907 сек.; синхронизировано_файлов=21, самая_долгая_синхр.=0.010 сек., средняя=0.003 сек.; расстояние=18896 kB, ожидалось=19103 kB
        2023-03-10 13:27:40.132 UTC [1727] СООБЩЕНИЕ:  начата контрольная точка: time
        2023-03-10 13:27:55.185 UTC [1727] СООБЩЕНИЕ:  контрольная точка завершена: записано буферов: 1961 (1.5%); добавлено файлов WAL 0, удалено: 0, переработано: 1; запись=14.812 сек., синхр.=0.069 сек., всего=15.054 сек.; синхронизировано_файлов=23, самая_долгая_синхр.=0.016 сек., средняя=0.003 сек.; расстояние=19102 kB, ожидалось=19103 kB
        2023-03-10 13:28:10.199 UTC [1727] СООБЩЕНИЕ:  начата контрольная точка: time
        2023-03-10 13:28:25.200 UTC [1727] СООБЩЕНИЕ:  контрольная точка завершена: записано буферов: 1999 (1.5%); добавлено файлов WAL 0, удалено: 0, переработано: 1; запись=14.847 сек., синхр.=0.063 сек., всего=15.001 сек.; синхронизировано_файлов=23, самая_долгая_синхр.=0.010 сек., средняя=0.003 сек.; расстояние=18828 kB, ожидалось=19076 kB
        2023-03-10 13:28:40.202 UTC [1727] СООБЩЕНИЕ:  начата контрольная точка: time
        2023-03-10 13:28:55.155 UTC [1727] СООБЩЕНИЕ:  контрольная точка завершена: записано буферов: 1889 (1.4%); добавлено файлов WAL 0, удалено: 0, переработано: 2; запись=14.682 сек., синхр.=0.067 сек., всего=14.953 сек.; синхронизировано_файлов=21, самая_долгая_синхр.=0.014 сек., средняя=0.004 сек.; расстояние=18833 kB, ожидалось=19052 kB
        2023-03-10 13:29:10.159 UTC [1727] СООБЩЕНИЕ:  начата контрольная точка: time
        2023-03-10 13:29:25.096 UTC [1727] СООБЩЕНИЕ:  контрольная точка завершена: записано буферов: 2015 (1.5%); добавлено файлов WAL 0, удалено: 0, переработано: 1; запись=14.793 сек., синхр.=0.053 сек., всего=14.938 сек.; синхронизировано_файлов=23, самая_долгая_синхр.=0.010 сек., средняя=0.003 сек.; расстояние=18922 kB, ожидалось=19039 kB
        2023-03-10 13:29:40.108 UTC [1727] СООБЩЕНИЕ:  начата контрольная точка: time
        2023-03-10 13:29:55.169 UTC [1727] СООБЩЕНИЕ:  контрольная точка завершена: записано буферов: 1918 (1.5%); добавлено файлов WAL 0, удалено: 0, переработано: 1; запись=14.900 сек., синхр.=0.066 сек., всего=15.062 сек.; синхронизировано_файлов=21, самая_долгая_синхр.=0.013 сек., средняя=0.004 сек.; расстояние=19033 kB, ожидалось=19038 kB
        2023-03-10 13:30:10.184 UTC [1727] СООБЩЕНИЕ:  начата контрольная точка: time
        2023-03-10 13:30:25.106 UTC [1727] СООБЩЕНИЕ:  контрольная точка завершена: записано буферов: 1919 (1.5%); добавлено файлов WAL 0, удалено: 0, переработано: 1; запись=14.777 сек., синхр.=0.052 сек., всего=14.922 сек.; синхронизировано_файлов=21, самая_долгая_синхр.=0.010 сек., средняя=0.003 сек.; расстояние=18885 kB, ожидалось=19023 kB
        2023-03-10 13:30:40.110 UTC [1727] СООБЩЕНИЕ:  начата контрольная точка: time
        2023-03-10 13:30:55.162 UTC [1727] СООБЩЕНИЕ:  контрольная точка завершена: записано буферов: 2045 (1.6%); добавлено файлов WAL 0, удалено: 0, переработано: 1; запись=14.898 сек., синхр.=0.060 сек., всего=15.053 сек.; синхронизировано_файлов=23, самая_долгая_синхр.=0.015 сек., средняя=0.003 сек.; расстояние=19352 kB, ожидалось=19352 kB
        2023-03-10 13:31:10.177 UTC [1727] СООБЩЕНИЕ:  начата контрольная точка: time
        2023-03-10 13:31:25.112 UTC [1727] СООБЩЕНИЕ:  контрольная точка завершена: записано буферов: 1931 (1.5%); добавлено файлов WAL 0, удалено: 0, переработано: 1; запись=14.795 сек., синхр.=0.065 сек., всего=14.935 сек.; синхронизировано_файлов=21, самая_долгая_синхр.=0.013 сек., средняя=0.004 сек.; расстояние=18760 kB, ожидалось=19292 kB
        2023-03-10 13:31:40.116 UTC [1727] СООБЩЕНИЕ:  начата контрольная точка: time
        2023-03-10 13:31:55.175 UTC [1727] СООБЩЕНИЕ:  контрольная точка завершена: записано буферов: 1935 (1.5%); добавлено файлов WAL 0, удалено: 0, переработано: 2; запись=14.909 сек., синхр.=0.044 сек., всего=15.059 сек.; синхронизировано_файлов=21, самая_долгая_синхр.=0.009 сек., средняя=0.003 сек.; расстояние=18664 kB, ожидалось=19230 kB
        2023-03-10 13:32:10.175 UTC [1727] СООБЩЕНИЕ:  начата контрольная точка: time
        2023-03-10 13:32:25.138 UTC [1727] СООБЩЕНИЕ:  контрольная точка завершена: записано буферов: 2118 (1.6%); добавлено файлов WAL 0, удалено: 0, переработано: 1; запись=14.821 сек., синхр.=0.059 сек., всего=14.963 сек.; синхронизировано_файлов=23, самая_долгая_синхр.=0.013 сек., средняя=0.003 сек.; расстояние=18804 kB, ожидалось=19187 kB
        2023-03-10 13:32:40.151 UTC [1727] СООБЩЕНИЕ:  начата контрольная точка: time
        2023-03-10 13:32:55.175 UTC [1727] СООБЩЕНИЕ:  контрольная точка завершена: записано буферов: 1920 (1.5%); добавлено файлов WAL 0, удалено: 0, переработано: 1; запись=14.796 сек., синхр.=0.075 сек., всего=15.024 сек.; синхронизировано_файлов=21, самая_долгая_синхр.=0.016 сек., средняя=0.004 сек.; расстояние=19152 kB, ожидалось=19183 kB
        2023-03-10 13:33:10.183 UTC [1727] СООБЩЕНИЕ:  начата контрольная точка: time
        2023-03-10 13:33:25.186 UTC [1727] СООБЩЕНИЕ:  контрольная точка завершена: записано буферов: 1928 (1.5%); добавлено файлов WAL 0, удалено: 0, переработано: 1; запись=14.842 сек., синхр.=0.077 сек., всего=15.004 сек.; синхронизировано_файлов=21, самая_долгая_синхр.=0.015 сек., средняя=0.004 сек.; расстояние=18708 kB, ожидалось=19136 kB
        2023-03-10 13:33:40.200 UTC [1727] СООБЩЕНИЕ:  начата контрольная точка: time
        2023-03-10 13:33:55.193 UTC [1727] СООБЩЕНИЕ:  контрольная точка завершена: записано буферов: 2134 (1.6%); добавлено файлов WAL 0, удалено: 0, переработано: 1; запись=14.828 сек., синхр.=0.066 сек., всего=14.993 сек.; синхронизировано_файлов=22, самая_долгая_синхр.=0.014 сек., средняя=0.003 сек.; расстояние=18835 kB, ожидалось=19106 kB
        2023-03-10 13:34:10.206 UTC [1727] СООБЩЕНИЕ:  начата контрольная точка: time
        2023-03-10 13:34:25.138 UTC [1727] СООБЩЕНИЕ:  контрольная точка завершена: записано буферов: 1906 (1.5%); добавлено файлов WAL 0, удалено: 0, переработано: 1; запись=14.791 сек., синхр.=0.059 сек., всего=14.932 сек.; синхронизировано_файлов=23, самая_долгая_синхр.=0.017 сек., средняя=0.003 сек.; расстояние=18624 kB, ожидалось=19058 kB
        2023-03-10 13:34:40.151 UTC [1727] СООБЩЕНИЕ:  начата контрольная точка: time
        2023-03-10 13:34:55.067 UTC [1727] СООБЩЕНИЕ:  контрольная точка завершена: записано буферов: 1752 (1.3%); добавлено файлов WAL 0, удалено: 0, переработано: 1; запись=14.861 сек., синхр.=0.016 сек., всего=14.916 сек.; синхронизировано_файлов=21, самая_долгая_синхр.=0.007 сек., средняя=0.001 сек.; расстояние=17083 kB, ожидалось=18860 kB
```

- все точки выполнились по расписанию, длительность выполнения ни разу не превысила 30 секунд (время расписания выполнения точек)


### Сравнение tps в синхронном/асинхронном режиме утилитой pgbench


- проверил tps в режиме синхронной фиксации транзакций:  

    ```
        pgbench (14.7 (Ubuntu 14.7-1.pgdg20.04+1))
        starting vacuum...end.
        progress: 60.0 s, 272.4 tps, lat 29.335 ms stddev 9.849
        progress: 120.0 s, 272.6 tps, lat 29.345 ms stddev 8.439
        progress: 180.0 s, 262.6 tps, lat 30.468 ms stddev 9.644
        progress: 240.0 s, 253.3 tps, lat 31.580 ms stddev 10.018
        progress: 300.0 s, 262.0 tps, lat 30.539 ms stddev 8.971
        progress: 360.0 s, 274.0 tps, lat 29.195 ms stddev 8.599
        progress: 420.0 s, 266.2 tps, lat 30.055 ms stddev 9.881
        progress: 480.0 s, 270.5 tps, lat 29.569 ms stddev 10.250
        progress: 540.0 s, 253.7 tps, lat 31.537 ms stddev 9.458
        progress: 600.0 s, 259.6 tps, lat 30.818 ms stddev 11.975
        transaction type: <builtin: TPC-B (sort of)>
        scaling factor: 1
        query mode: simple
        number of clients: 8
        number of threads: 1
        duration: 600 s
        number of transactions actually processed: 158822
        latency average = 30.221 ms
        latency stddev = 9.781 ms
        initial connection time = 39.423 ms
        tps = 264.703344 (without initial connection time)

    ```

- для замера tps в режиме **асинхронной** фиксации транзакций изменил параметр `synchronous_commit = off`
    `ALTER SYSTEM SET synchronous_commit = off;`
- запустил проверку в режиме асинхронной фиксации транзакций: 

    `pgbench -c 8 -P 60 -T 600 -U postgres postgres`

    ```
    pgbench (14.7 (Ubuntu 14.7-1.pgdg20.04+1))
    starting vacuum...end.
    progress: 60.0 s, 2467.8 tps, lat 3.239 ms stddev 1.195
    progress: 120.0 s, 2372.5 tps, lat 3.372 ms stddev 1.007
    progress: 180.0 s, 2362.2 tps, lat 3.386 ms stddev 0.978
    progress: 240.0 s, 2349.9 tps, lat 3.404 ms stddev 1.055
    progress: 300.0 s, 2368.0 tps, lat 3.378 ms stddev 1.024
    progress: 360.0 s, 2366.2 tps, lat 3.381 ms stddev 0.997
    progress: 420.0 s, 2352.4 tps, lat 3.401 ms stddev 0.972
    progress: 480.0 s, 2382.9 tps, lat 3.357 ms stddev 0.973
    progress: 540.0 s, 2391.9 tps, lat 3.344 ms stddev 0.945
    progress: 600.0 s, 2382.1 tps, lat 3.358 ms stddev 0.998
    transaction type: <builtin: TPC-B (sort of)>
    scaling factor: 1
    query mode: simple
    number of clients: 8
    number of threads: 1
    duration: 600 s
    number of transactions actually processed: 1427761
    latency average = 3.361 ms
    latency stddev = 1.018 ms
    initial connection time = 40.324 ms
    tps = 2379.715092 (without initial connection time)
    ``` 

- В режиме асинхронного подтверждения сервер сообщает об успешном завершении сразу, как только транзакция будет завершена логически, прежде чем сгенерированные записи WAL фактически будут записаны на диск..
- Видим 9 кратный прирост

- создаем кластер с включенным контролем
`sudo pg_createcluster 14 checks -- --data-checksum`

- список  
`pg_lsclusters`
```
Ver Cluster Port Status Owner    Data directory                Log file
14  checks  5433 online postgres /var/lib/postgresql/14/checks /var/log/postgresql/postgresql-14-checks.log
14  main    5432 online postgres /var/lib/postgresql/14/main   /var/log/postgresql/postgresql-14-main.log
```
- подключение
`sudo -u postgres psql -p 5433`

- создал базу и вошел в неё
```
    postgres=# create database checkbase;
    postgres=# \c checkbase
```

- создал таблицу
```
checkbase=# create table simletable(id int, datavalue varchar(10));
CREATE TABLE
```
- внес данные
```
checkbase=# insert into simletable (id,datavalue) values(300,'три сотни'),(4,'четыре');
INSERT 0 2
```
- посмотрел расположение файла таблицы
```
checkbase=# select pg_relation_filepath('simletable');
 pg_relation_filepath
----------------------
 base/16384/16388
(1 строка)
```
- во второй  сессии терминала остановил принудительно сервер 
 `sudo pkill -9 postgres`
- изменил данные в файле таблицы (сотрем из заголовка LSN последней журнальной записи)
`$ sudo dd if=/dev/zero of=/var/lib/postgresql/14/checks/base/16384/16388 oflag=dsync conv=notrunc bs=1 count=8`

- в первой сессии выполняю
```
checkbase=# select * from simletable;
ПРЕДУПРЕЖДЕНИЕ:  ошибка проверки страницы: получена контрольная сумма 54709, а ожидалась - 2236
ОШИБКА:  неверная страница в блоке 0 отношения base/16384/16388
```
- были обнаружены ошибки контрольных сумм файла таблицы. Игнорировать ошибку поможет параметр [ignore_checksum_failure] установленный в значение true.
- проверка
```
checkbase=# show ignore_checksum_failure;
 ignore_checksum_failure
-------------------------
 off
(1 строка)
```
- включаем
```
checkbase=# set ignore_checksum_failure = on;
SET
```
 - повторная выборка
```
checkbase=# select * from simletable;
ПРЕДУПРЕЖДЕНИЕ:  ошибка проверки страницы: получена контрольная сумма 54709, а ожидалась - 2236
 id  | datavalue
-----+-----------
 300 | три сотни
   4 | четыре
(2 строки)
```

